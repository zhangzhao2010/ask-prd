# ASK-PRD 需求文档

> 版本：v1.0
> 更新时间：2025-01-20

---

## 一、项目概述

### 1.1 项目背景

ASK-PRD 是一个为产品经理提供基于PRD（产品需求文档）的智能检索和问答系统。

产品经理在日常工作中会积累大量的PRD文档（PDF格式），每个文档包含特定版本的需求迭代信息。文档通常为图文混排，包含：
- 流程图
- 产品原型图
- 思维导图
- 架构图
- 其他说明性图片

经过多个版本的迭代，某些产品功能和特性可能经历多次变更。当新人加入团队或需要回溯产品演进历程时，手动查阅大量历史文档效率低下。

### 1.2 项目目标

通过构建智能检索和生成系统，实现：
1. **快速检索**：从海量PRD文档中快速找到相关信息
2. **智能理解**：理解图文混排内容，包括流程图、原型图等
3. **准确回答**：基于多个文档综合生成准确答案
4. **溯源引用**：提供答案来源，包括文本和图片引用

### 1.3 项目定位

- **Demo项目**：重点验证核心技术能力
- **单用户**：不涉及多用户和权限管理
- **核心聚焦**：检索准确性和答案质量

---

## 二、典型使用场景

### 场景1：产品功能演进查询

**用户提问**：
> "xx APP的注册登录方式的演进是怎样的？"

**系统处理**：
1. 检索所有提到"注册"、"登录"的相关PRD文档
2. 按时间顺序阅读v1.0、v1.5、v2.0等版本文档
3. 提取每个版本的登录方式变更信息
4. 综合生成演进历程报告

**输出结果**：
```
根据检索到的文档，注册登录模块经历了以下演进：

**第一阶段（v1.0，2023-01）**：
- 仅支持手机号+短信验证码登录
- 引用：[PRD_v1.0.pdf - 第5页]

**第二阶段（v1.5，2023-06）**：
- 新增微信登录
- 新增邮箱+密码登录
- 引用：[PRD_v1.5.pdf - 登录流程图]

**第三阶段（v2.0，2024-01）**：
- 增加人脸识别登录
- 支持第三方OAuth（微信、Apple、Google）
- 引用：[PRD_v2.0.pdf - 第12页]
```

### 场景2：复杂功能原型查询

**用户提问**：
> "支付模块的交互流程是怎样的？"

**系统处理**：
1. 检索"支付"相关文档
2. 识别流程图、原型图等关键图片
3. 理解图片内容并生成描述
4. 结合文字说明综合回答

**输出结果**：
- 文字描述支付流程
- 展示原型图（图片）
- 展示流程图（图片）
- 提供引用来源

### 场景3：需求变更历史追溯

**用户提问**：
> "购物车功能在哪些版本做过调整？"

**系统处理**：
1. 跨版本检索"购物车"相关内容
2. 对比不同版本的差异
3. 总结每次变更的核心内容

---

## 三、功能需求

### 3.1 知识库管理

#### 3.1.1 知识库列表
- 展示所有已创建的知识库
- 显示知识库名称、描述、文档数量、创建时间

#### 3.1.2 创建知识库
- 输入知识库名称（必填）
- 输入描述信息（可选）
- 指定S3存储位置（桶名+路径前缀）
- 系统自动创建OpenSearch Collection和Index
- 元数据存储到本地SQLite数据库

#### 3.1.3 删除知识库
- 删除知识库及所有关联数据
- 删除OpenSearch中的索引
- 删除本地缓存的文件

### 3.2 文档管理

#### 3.2.1 文档列表
- 下拉框选择知识库
- 展示当前知识库的所有文档
- 显示文档名称、状态、上传时间、文件大小、页数
- 支持按状态过滤（已上传/处理中/已完成/失败）
- 支持分页

#### 3.2.2 上传文档
- 选择目标知识库
- 支持单个或批量上传PDF文件
- 自动上传到指定的S3桶
- 显示上传进度

#### 3.2.3 删除文档
- 支持多选删除
- 同步删除关联数据：
  - S3中的原始PDF
  - 转换后的Markdown和图片
  - OpenSearch中的向量数据
  - SQLite中的元数据

#### 3.2.4 数据同步
- 点击"数据同步"按钮触发同步任务
- 支持全量同步和增量同步
- 异步后台处理，创建任务记录
- 显示同步进度和状态

### 3.3 检索问答

#### 3.3.1 问答界面
- 参考Perplexity的设计风格
- 中央搜索框输入问题
- 流式输出答案（打字机效果）
- 左侧展示历史查询记录
- 右侧或底部展示引用来源

#### 3.3.2 提问功能
- 输入自然语言问题
- 提交后实时展示处理状态：
  - "正在改写查询..."
  - "正在检索文档..."
  - "正在阅读文档 1/3..."
  - "正在生成答案..."

#### 3.3.3 答案展示
- 流式输出答案内容
- Markdown格式渲染
- 展示Token消耗统计（提示词/生成/总计）
- 答案底部展示引用列表

#### 3.3.4 引用展示
- **文本引用**：显示引用文本片段+来源文档+位置
- **图片引用**：直接展示图片+图片描述+来源文档
- 点击引用可跳转到来源详情

#### 3.3.5 历史记录
- 左侧导航展示历史查询
- 显示问题预览（前50字）
- 显示查询时间
- 点击可查看完整问答详情
- 支持分页加载

### 3.4 任务管理

#### 3.4.1 同步任务列表
- 展示所有同步任务
- 显示任务状态（待处理/运行中/已完成/失败）
- 显示任务进度百分比
- 显示当前处理步骤
- 显示成功/失败文档数量

#### 3.4.2 任务详情
- 查看任务完整信息
- 查看失败文档列表及失败原因
- 支持重试失败文档
- 支持取消运行中的任务

---

## 四、非功能需求

### 4.1 性能要求

- 问答响应时间：< 30秒（包含检索、阅读、生成全流程）
- 文档上传：支持最大100MB的PDF文件
- 并发处理：同步任务支持5个文档并发处理
- 流式输出延迟：< 500ms 首字节响应

### 4.2 可用性要求

- 系统整体可用性：> 95%（Demo阶段）
- 降级策略：关键步骤失败时提供降级方案
- 错误提示：清晰的错误信息和操作建议

### 4.3 数据要求

- 本地文件缓存：检查本地是否已有文件，避免重复下载
- 数据一致性：删除操作需确保相关数据完全清理
- 备份：SQLite数据库定期备份（手动）

### 4.4 安全要求

- S3访问：使用IAM角色或密钥认证
- Bedrock访问：使用IAM角色授权
- OpenSearch访问：使用访问策略控制
- 输入验证：防止SQL注入、路径穿越等攻击

### 4.5 扩展性考虑

虽然是Demo项目，但架构设计应考虑未来扩展：
- 数据库迁移：SQLite → RDS的迁移路径
- 多实例部署：Session管理和文件缓存方案
- 用户系统：预留用户ID字段
- 权限控制：知识库访问权限预留

---

## 五、约束条件

### 5.1 技术约束

- 前端：Next.js 16 + AWS Cloudscape
- 后端：Python 3.12 + FastAPI
- Agent框架：Strands Agents SDK（用于Multi-Agent实现）
- 数据库：SQLite（本地）
- 向量数据库：Amazon OpenSearch Serverless
- 对象存储：Amazon S3
- AI服务：AWS Bedrock（通过Strands BedrockModel集成）
  - Region: us-west-2
  - Model: Claude Sonnet 4.5 (global.anthropic.claude-sonnet-4-5-20250929-v1:0)
  - 已配置所需权限
- PDF转换：datalab-to/marker
- 部署：单一EC2实例（带GPU）

### 5.2 业务约束

- 仅支持PDF格式文档
- 不支持多用户和权限管理
- 不支持多轮对话（每次提问独立）
- 暂不考虑成本优化

### 5.3 已知限制

- Marker转换依赖GPU，处理速度受硬件限制
- Bedrock有API限流，高并发时需要重试机制
- 单机部署，无法水平扩展
- SQLite并发写入能力有限

---

## 六、验收标准

### 6.1 核心功能验收

- [ ] 能够成功创建知识库并关联S3和OpenSearch
- [ ] 能够上传PDF文档到S3
- [ ] 能够触发同步任务，完成PDF→Markdown→向量的全流程
- [ ] 能够识别并处理文档中的图片
- [ ] 能够针对用户提问进行检索并生成答案
- [ ] 答案能够流式输出
- [ ] 能够展示文本和图片引用
- [ ] 历史记录能够正常保存和查看

### 6.2 质量验收

- [ ] 检索准确率：相关文档召回率 > 80%
- [ ] 答案质量：生成的答案准确且连贯
- [ ] 引用准确性：引用内容与答案对应
- [ ] 错误处理：关键错误有清晰提示和重试机制
- [ ] UI体验：界面清晰，操作流畅

### 6.3 边界场景验收

- [ ] 上传非PDF文件能够正确拒绝
- [ ] PDF转换失败能够正确处理和提示
- [ ] 检索无结果时能够友好提示
- [ ] 网络异常能够自动重试
- [ ] 并发请求不会导致数据混乱

---

## 七、里程碑规划

### Phase 1：基础框架（2周）
- [ ] 项目架构搭建
- [ ] 数据库Schema实现
- [ ] S3和OpenSearch集成
- [ ] 基础API框架

### Phase 2：知识库构建（3周）
- [ ] PDF上传功能
- [ ] Marker转换集成
- [ ] 图片理解（Bedrock Claude）
- [ ] 文本分块和向量化
- [ ] 数据同步任务系统

### Phase 3：检索问答（3周）
- [ ] 向量检索（Hybrid Search）
- [ ] Query Rewrite
- [ ] Multi-Agent系统
- [ ] 流式输出
- [ ] 引用提取和展示

### Phase 4：前端开发（2周）
- [ ] 知识库管理界面
- [ ] 文档管理界面
- [ ] 问答界面
- [ ] 历史记录界面

### Phase 5：测试和优化（1周）
- [ ] 功能测试
- [ ] 性能测试
- [ ] 错误处理完善
- [ ] 文档完善
